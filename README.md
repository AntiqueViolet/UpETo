<h1 align="center">ETArch ‚Äî –Ω–∞–¥—ë–∂–Ω–∞—è –∞—Ä—Ö–∏–≤–∞—Ü–∏—è MySQL —Å Telegram‚Äë–±–æ—Ç–æ–º</h1>

<p align="center">
  <a href="https://github.com/AntiqueViolet/UpETo">
    <img src="https://img.shields.io/github/actions/workflow/status/AntiqueViolet/UpETo/docker-publish.yml?label=Build&logo=github" alt="Build Status">
  </a>
  <a href="https://hub.docker.com/r/malolet/upeto">
    <img src="https://img.shields.io/docker/pulls/malolet/upeto?logo=docker" alt="Docker Pulls">
  </a>
</p>

---

## üìñ –û–ø–∏—Å–∞–Ω–∏–µ

**ETArch** ‚Äî —Å–µ—Ä–≤–∏—Å –¥–ª—è –ø–∞–∫–µ—Ç–Ω–æ–π –∞—Ä—Ö–∏–≤–∞—Ü–∏–∏ —Å—Ç—Ä–æ–∫ –≤ MySQL –ø–æ —É—Å–ª–æ–≤–∏—é `validity < now - 1 day` —Å —É—Å—Ç–æ–π—á–∏–≤–æ—Å—Ç—å—é –∫ –æ–±—Ä—ã–≤–∞–º, –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–º –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ–º, —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ–º —á–µ—Ä–µ–∑ Telegram –∏ —Ä–∞–∑–≤—ë—Ä—Ç—ã–≤–∞–Ω–∏–µ–º –≤ Docker.

---

## ‚ú® –í–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏
- –ë–∞—Ç—á–µ–≤–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å –±–µ–∑–æ–ø–∞—Å–Ω—ã–º–∏ –∫–æ–º–º–∏—Ç–∞–º–∏.
- –ü–ª–∞–≤–Ω—ã–µ –∑–∞–¥–µ—Ä–∂–∫–∏ –º–µ–∂–¥—É –±–∞—Ç—á–∞–º–∏ (–ø–∞—É–∑–∞ + –¥–∂–∏—Ç—Ç–µ—Ä + extra).
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —É–º–µ–Ω—å—à–µ–Ω–∏–µ —Ä–∞–∑–º–µ—Ä–∞ –±–∞—Ç—á–∞ –ø—Ä–∏ —Ç–∞–π–º‚Äë–∞—É—Ç–∞—Ö.
- Telegram‚Äë–±–æ—Ç: `/status`, `/run_now`, `/restart_container`.
- –ü–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫ CRON –≤ –ª—é–±–æ–π —Ç–∞–π–º–∑–æ–Ω–µ.
- –ß–µ–∫–ø–æ–∏–Ω—Ç –ø—Ä–æ–≥—Ä–µ—Å—Å–∞ –∏ –≤–æ–∑–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–æ—Å–ª–µ —Å–±–æ–µ–≤.
- –õ–æ–≥–∏ —Å —Ä–æ—Ç–∞—Ü–∏–µ–π –≤ —Ñ–∞–π–ª –∏ stdout.
- –ü–æ–ª–Ω–∞—è —É–ø–∞–∫–æ–≤–∫–∞ –≤ Docker.

---

## üöÄ –ë—ã—Å—Ç—Ä—ã–π —Å—Ç–∞—Ä—Ç

1. **–ù–∞—Å—Ç—Ä–æ–π–∫–∞** (`docker-compose.yml`):
```yaml
services:
  etarch:
    build: .
    restart: always
    environment:
      DB_USER: root
      DB_PASSWORD: dbpassword
      DB_HOST: 127.0.0.1
      DB_PORT: "3306"
      DB_NAME: dbname
      TG_BOT_TOKEN: "<–≤–∞—à_—Ç–æ–∫–µ–Ω>"
      TG_CHAT_ID: "<id_—á–∞—Ç–∞>"
      TG_ALLOWED_USER_IDS: "<–≤–∞—à_user_id>"
      CRON_TIME: "10 2 * * *"
      TZ: "Europe/Moscow"
      LOG_FILE: /app/data/etarch.log
      CKPT_FILE: /app/data/etarch.ckpt.json
    volumes:
      - ./data:/app/data
```

2. **–°–±–æ—Ä–∫–∞ –∏ –∑–∞–ø—É—Å–∫**:
```bash
docker compose build
docker compose up -d
```

3. **–ü—Ä–æ–≤–µ—Ä–∫–∞ –ª–æ–≥–æ–≤**:
```bash
docker compose logs -f
```

---

## ü§ñ –ü—Ä–∏–º–µ—Ä—ã —Ä–∞–±–æ—Ç—ã Telegram‚Äë–±–æ—Ç–∞

**–ó–∞–ø—Ä–æ—Å**:
```
/status
```

**–û—Ç–≤–µ—Ç**:
```
{
  "started_at": "2025-08-14T02:10:00Z",
  "finished_at": "2025-08-14T02:15:42Z",
  "running": false,
  "total_updated": 184320,
  "last_id": 9821131,
  "error": null,
  "batch_size": 20000
}
```

---

**–ó–∞–ø—Ä–æ—Å**:
```
/run_now
```

**–û—Ç–≤–µ—Ç**:
```
–ó–∞–ø—É—Å–∫–∞—é –∑–∞–¥–∞—á—É –∞—Ä—Ö–∏–≤–∞—Ü–∏–∏...
‚úÖ –ì–æ—Ç–æ–≤–æ. –ò—Ç–æ–≥: –æ–±–Ω–æ–≤–ª–µ–Ω–æ 152000 —Å—Ç—Ä–æ–∫.
```

---

## ‚öôÔ∏è –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è

| –ü–µ—Ä–µ–º–µ–Ω–Ω–∞—è | –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é | –û–ø–∏—Å–∞–Ω–∏–µ |
|------------|--------------|----------|
| `DB_USER` | ‚Äî | –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å MySQL |
| `DB_PASSWORD` | ‚Äî | –ü–∞—Ä–æ–ª—å MySQL |
| `DB_HOST` | ‚Äî | –•–æ—Å—Ç –ë–î |
| `DB_PORT` | ‚Äî | –ü–æ—Ä—Ç –ë–î |
| `DB_NAME` | ‚Äî | –ò–º—è –±–∞–∑—ã |
| `BATCH_SIZE` | 20000 | –†–∞–∑–º–µ—Ä –±–∞—Ç—á–∞ |
| `MIN_BATCH_SIZE` | 2000 | –ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–π –±–∞—Ç—á –ø—Ä–∏ —Å–±–æ—è—Ö |
| `BATCH_SLEEP_MS` | 150 | –ü–∞—É–∑–∞ –º–µ–∂–¥—É –±–∞—Ç—á–∞–º–∏ |
| `BATCH_SLEEP_JITTER_MS` | 100 | –î–∂–∏—Ç—Ç–µ—Ä –∑–∞–¥–µ—Ä–∂–∫–∏ |
| `SLOWDOWN_AFTER_ROWS` | 15000 | –ü–æ—Ä–æ–≥ –¥–ª—è extra‚Äë–ø–∞—É–∑—ã |
| `SLOWDOWN_EXTRA_MS` | 500 | –î–æ–ø. –ø–∞—É–∑–∞ (–º—Å) |
| `READ_TIMEOUT` | 120 | –¢–∞–π–º‚Äë–∞—É—Ç —á—Ç–µ–Ω–∏—è |
| `WRITE_TIMEOUT` | 120 | –¢–∞–π–º‚Äë–∞—É—Ç –∑–∞–ø–∏—Å–∏ |
| `CRON_TIME` | "10 2 * * *" | –†–∞—Å–ø–∏—Å–∞–Ω–∏–µ |
| `TZ` | UTC | –¢–∞–π–º–∑–æ–Ω–∞ |
| `TG_BOT_TOKEN` | ‚Äî | –¢–æ–∫–µ–Ω –±–æ—Ç–∞ |
| `TG_CHAT_ID` | ‚Äî | ID —á–∞—Ç–∞ |
| `TG_ALLOWED_USER_IDS` | ‚Äî | –†–∞–∑—Ä–µ—à—ë–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ |

---

## üõ† –¢—é–Ω–∏–Ω–≥ –∏ —Å–æ–≤–µ—Ç—ã
- –£–º–µ–Ω—å—à–∞–π—Ç–µ `BATCH_SIZE`, –µ—Å–ª–∏ –ë–î –Ω–µ —Å–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è.
- –£–≤–µ–ª–∏—á–∏–≤–∞–π—Ç–µ `READ_TIMEOUT`/`WRITE_TIMEOUT` –ø—Ä–∏ –¥–æ–ª–≥–∏—Ö –±–∞—Ç—á–∞—Ö.
- –î–æ–±–∞–≤—å—Ç–µ –∏–Ω–¥–µ–∫—Å `(validity, status, id)` –¥–ª—è —É—Å–∫–æ—Ä–µ–Ω–∏—è.

---

## üìú –õ–∏—Ü–µ–Ω–∑–∏—è
MIT
